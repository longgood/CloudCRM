{% extends "layouts/base.html" %}

{% block title %} Email Contacts {% endblock %}

{% block content %}
<div class="py-4">
  <nav aria-label="breadcrumb" class="d-none d-md-inline-block">
    <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
      <li class="breadcrumb-item"><a href="/index"><svg class="icon icon-xxs" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></a></li>
      <li class="breadcrumb-item"><a href="#">Email Contacts</a></li>
      <li class="breadcrumb-item active" aria-current="page">Contact List</li>
    </ol>
  </nav>
  <div class="d-flex justify-content-between w-100 flex-wrap">
    <div class="mb-3 mb-lg-0">
      <h1 class="h4">Email Contacts</h1>
      <p class="mb-0">
        Gmail: <strong>{{ gmail_account.google_email }}</strong> |
        Last Sync: <strong>{{ gmail_account.last_sync_at.strftime('%Y-%m-%d %H:%M') if gmail_account.last_sync_at else 'Never' }}</strong>
      </p>
    </div>
    <div>
      <form method="POST" action="{{ url_for('gmail_blueprint.sync') }}" class="d-inline">
        <input type="hidden" name="days" value="365">
        <button type="submit" class="btn btn-sm btn-primary">
          <svg class="icon icon-xs me-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path></svg>
          Sync Now
        </button>
      </form>
    </div>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Filter & Search Bar -->
<div class="card border-0 shadow mb-4">
  <div class="card-body">
    <form method="GET" action="{{ url_for('gmail_blueprint.contacts') }}" class="row g-3 align-items-end">
      <div class="col-auto">
        <label for="levelFilter" class="form-label fw-bold">Interaction Level</label>
        <select name="level" id="levelFilter" class="form-select">
          <option value="" {% if level_filter == '' %}selected{% endif %}>All Levels</option>
          <option value="0" {% if level_filter == '0' %}selected{% endif %}>Level 0 - Any Contact</option>
          <option value="1" {% if level_filter == '1' %}selected{% endif %}>Level 1 - Bidirectional</option>
          <option value="2" {% if level_filter == '2' %}selected{% endif %}>Level 2 - Stable (900d)</option>
          <option value="3" {% if level_filter == '3' %}selected{% endif %}>Level 3 - Active (180d)</option>
        </select>
      </div>
      <div class="col">
        <label for="searchQuery" class="form-label fw-bold">Search</label>
        <input type="text" name="q" id="searchQuery" class="form-control" placeholder="Search by email or name..." value="{{ search_query }}">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{{ url_for('gmail_blueprint.contacts') }}" class="btn btn-outline-secondary">Clear</a>
      </div>
    </form>
  </div>
</div>

<!-- Contacts Table -->
<div class="card border-0 shadow">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="fs-5 fw-bold mb-0">Contacts ({{ pagination.total }})</h2>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-centered table-hover mb-0">
        <thead class="thead-light">
          <tr>
            <th class="border-0">#</th>
            <th class="border-0">Email</th>
            <th class="border-0">Name</th>
            <th class="border-0">Level</th>
            <th class="border-0">Inbound</th>
            <th class="border-0">Outbound</th>
            <th class="border-0">Last Interaction</th>
            <th class="border-0">Recent Subject</th>
          </tr>
        </thead>
        <tbody>
          {% for contact in contacts %}
          <tr>
            <td>{{ loop.index + (pagination.page - 1) * pagination.per_page }}</td>
            <td class="fw-bold">{{ contact.contact_email }}</td>
            <td>{{ contact.contact_name or '-' }}</td>
            <td>
              {% if contact.level == 3 %}
                <span class="badge bg-success">Level 3</span>
              {% elif contact.level == 2 %}
                <span class="badge bg-primary">Level 2</span>
              {% elif contact.level == 1 %}
                <span class="badge bg-info">Level 1</span>
              {% else %}
                <span class="badge bg-secondary">Level 0</span>
              {% endif %}
            </td>
            <td>{{ contact.inbound_count }}</td>
            <td>{{ contact.outbound_count }}</td>
            <td>{{ contact.last_interaction_at.strftime('%Y-%m-%d') if contact.last_interaction_at else '-' }}</td>
            <td class="text-truncate" style="max-width: 250px;" title="{{ contact.last_subject or '' }}">
              {{ contact.last_subject or '-' }}
            </td>
          </tr>
          {% endfor %}
          {% if not contacts %}
          <tr>
            <td colspan="8" class="text-center py-4 text-muted">
              No contacts found. Try syncing your Gmail or adjusting filters.
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('gmail_blueprint.contacts', page=pagination.prev_num, level=level_filter, q=search_query) }}">Previous</a>
        </li>
        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
          {% if p %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('gmail_blueprint.contacts', page=p, level=level_filter, q=search_query) }}">{{ p }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('gmail_blueprint.contacts', page=pagination.next_num, level=level_filter, q=search_query) }}">Next</a>
        </li>
      </ul>
    </nav>
    {% endif %}
  </div>
</div>

<!-- Level Legend -->
<div class="card border-0 shadow mt-4">
  <div class="card-body">
    <h3 class="fs-6 fw-bold mb-3">Interaction Levels</h3>
    <div class="row">
      <div class="col-md-3">
        <span class="badge bg-secondary">Level 0</span> Any contact (at least 1 email in either direction)
      </div>
      <div class="col-md-3">
        <span class="badge bg-info">Level 1</span> Bidirectional (at least 1 email each way)
      </div>
      <div class="col-md-3">
        <span class="badge bg-primary">Level 2</span> Stable (2+ each way, within 900 days)
      </div>
      <div class="col-md-3">
        <span class="badge bg-success">Level 3</span> Active (3+ each way, within 180 days)
      </div>
    </div>
  </div>
</div>
{% endblock content %}
